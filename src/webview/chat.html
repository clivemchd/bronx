<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'none'; style-src 'unsafe-inline'; script-src 'nonce-{{nonce}}'; font-src vscode-resource:;">
    <title>Bronx Chat</title>
    <style>
        body {
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
            color: var(--vscode-foreground);
            background-color: var(--vscode-editor-background);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            padding: 16px 20px;
            background-color: var(--vscode-sideBar-background);
            border-bottom: 1px solid var(--vscode-sideBar-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h2 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--vscode-foreground);
        }

        .model-selector {
            background-color: var(--vscode-dropdown-background);
            color: var(--vscode-dropdown-foreground);
            border: 1px solid var(--vscode-dropdown-border);
            border-radius: 3px;
            padding: 4px 8px;
            font-size: 12px;
            outline: none;
        }

        .model-status {
            font-size: 11px;
            color: var(--vscode-descriptionForeground);
            margin-left: 10px;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .message.user {
            align-self: flex-end;
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
        }

        .message.assistant {
            align-self: flex-start;
            background-color: var(--vscode-input-background);
            border: 1px solid var(--vscode-input-border);
        }

        .message .timestamp {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 5px;
        }

        .code-block {
            background-color: var(--vscode-textCodeBlock-background);
            border: 1px solid var(--vscode-input-border);
            border-radius: 6px;
            margin: 8px 0;
            overflow: hidden;
        }

        .code-header {
            background-color: var(--vscode-badge-background);
            color: var(--vscode-badge-foreground);
            padding: 6px 12px;
            font-size: 11px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .code-content {
            padding: 12px;
            font-family: var(--vscode-editor-font-family);
            font-size: var(--vscode-editor-font-size);
            white-space: pre;
            overflow-x: auto;
        }

        .code-actions {
            display: flex;
            gap: 8px;
        }

        .code-action-btn {
            background: none;
            border: none;
            color: var(--vscode-button-foreground);
            cursor: pointer;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .code-action-btn:hover {
            background-color: var(--vscode-button-hoverBackground);
        }

        .input-container {
            padding: 16px;
            background-color: var(--vscode-sideBar-background);
            border-top: 1px solid var(--vscode-sideBar-border);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .input-top-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .model-selector-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .model-selector {
            background-color: var(--vscode-dropdown-background);
            color: var(--vscode-dropdown-foreground);
            border: 1px solid var(--vscode-dropdown-border);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 13px;
            font-weight: 500;
            outline: none;
            cursor: pointer;
            min-width: 140px;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 5"><path fill="%23666" d="m0 1 2 2 2-2z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 8px;
            padding-right: 28px;
        }

        .model-selector:hover {
            background-color: var(--vscode-dropdown-listBackground);
        }

        .input-main-container {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            background-color: var(--vscode-input-background);
            border: 1px solid var(--vscode-input-border);
            border-radius: 12px;
            padding: 4px;
            transition: all 0.2s ease;
        }

        .input-main-container:focus-within {
            border-color: #8b5cf6;
            box-shadow: 0 0 0 1px #8b5cf6;
            transform: translateY(-1px);
        }

        .input-box {
            flex: 1;
            min-height: 20px;
            max-height: 120px;
            padding: 12px 16px;
            background-color: transparent;
            color: var(--vscode-input-foreground);
            border: none;
            resize: none;
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
            outline: none;
            overflow-y: auto;
            line-height: 1.4;
            transition: all 0.2s ease;
        }

        .input-box::placeholder {
            color: var(--vscode-input-placeholderForeground);
            opacity: 0.7;
        }

        .input-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px;
        }

        .action-button {
            background: none;
            border: none;
            color: var(--vscode-foreground);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            transition: all 0.2s ease;
            transform: scale(1);
        }

        .action-button:hover {
            opacity: 1;
            background-color: var(--vscode-list-hoverBackground);
            transform: scale(1.05);
        }

        .action-button:active {
            transform: scale(0.95);
        }

        .action-button svg {
            width: 16px;
            height: 16px;
        }

        .send-button {
            background-color: #8b5cf6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            outline: none;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            height: 36px;
            opacity: 1;
            transition: all 0.2s ease;
            transform: scale(1);
        }

        .send-button:hover:not(:disabled) {
            background-color: #7c3aed;
            transform: scale(1.05);
        }

        .send-button:active:not(:disabled) {
            transform: scale(0.95);
        }

        .send-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background-color: var(--vscode-button-secondaryBackground);
            transform: scale(1);
        }

        .send-button svg {
            width: 16px;
            height: 16px;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--vscode-descriptionForeground);
            font-style: italic;
            padding: 12px 16px;
        }

        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--vscode-progressBar-background);
            border-top: 2px solid var(--vscode-button-background);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .download-progress {
            background-color: var(--vscode-notifications-background);
            border: 1px solid var(--vscode-notifications-border);
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background-color: var(--vscode-progressBar-background);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--vscode-button-background);
            transition: width 0.3s ease;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--vscode-descriptionForeground);
            text-align: center;
            padding: 40px;
        }

        .empty-state .logo {
            width: 64px;
            height: 64px;
            margin-bottom: 20px;
            opacity: 0.8;
        }

        .empty-state .logo svg {
            width: 100%;
            height: 100%;
            color: var(--vscode-foreground);
        }

        .empty-state h2 {
            margin: 0 0 10px 0;
            font-size: 18px;
            font-weight: 600;
        }

        .empty-state p {
            margin: 0;
            font-size: 14px;
            line-height: 1.4;
        }
    </style>
</head>

<body>
    <div class="header">
        <h2>Bronx Chat</h2>
        <div class="model-status" id="modelStatus">No model selected</div>
    </div>

    <div class="chat-container" id="chatContainer">
        <div class="empty-state">
            <div class="logo">
                <?xml version="1.0" encoding="UTF-8"?>
                <svg version="1.1" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <g>
                        <!-- Background circle -->
                        <path d="m12 0c6.6289 0 12 5.3711 12 12s-5.3711 12-12 12-12-5.3711-12-12 5.3711-12 12-12z"
                            fill="#000000" />
                        <!-- white cat body shape -->
                        <path
                            d="m9.0703 4.8945c0.53906 0.027344 0.98047 0.37109 1.3945 0.6875 0.12891 0.097657 0.23047 0.17578 0.38281 0.22656-0.03125-0.078125-0.0625-0.16016-0.09375-0.24219 0.78125-0.25781 1.8242 0.039063 2.5391 0.38281 0.38672 0.19531 0.73438 0.4375 1.0586 0.72266 0.035157 0.03125 0.070313 0.058594 0.10547 0.089844 0.25391 0.23438 0.4375 0.5 0.56641 0.82422v0.19141c-0.22266 0.0625-0.44141 0.125-0.67188 0.19141 0.082032-0.015625 0.16797-0.03125 0.25391-0.046875 0.16016-0.03125 0.30078-0.050781 0.46484-0.050781 0.015626 0.082031 0.035157 0.16016 0.050782 0.24219-0.23828 0.023438-0.23828 0.023438-0.48047 0.046875h0.48047c0.015625 0.078125 0.03125 0.16016 0.046875 0.23828h-0.76953c0.25391 0.015624 0.50781 0.035156 0.76953 0.050781 0.03125 0.4375-0.066407 0.86719-0.27344 1.2578-0.082031 0.13281-0.082031 0.13281-0.015625 0.27734 0.03125 0.015625 0.066406 0.03125 0.097656 0.046875v0.097656c-0.0625 0.015625-0.12891 0.03125-0.19141 0.046875 0.023438 0.027344 0.046875 0.054688 0.074219 0.085938 0.59766 0.71094 0.59766 0.71094 0.59766 1.1133-0.046875 0.015625-0.097656 0.03125-0.14453 0.050781 0.015625 0.023438 0.03125 0.046875 0.046875 0.070313 0.035156 0.050781 0.035156 0.050781 0.066406 0.10156 0.019531 0.03125 0.042969 0.066406 0.0625 0.097656 0.21094 0.37891 0.21875 0.78906 0.11719 1.1992-0.035157 0.10938-0.070313 0.21875-0.10938 0.32422-0.046875 0.11719-0.046875 0.11719-0.039063 0.22266 0.015625-0.039062 0.03125-0.074218 0.046875-0.10938 0.023438-0.046875 0.042969-0.09375 0.066406-0.14453 0.019532-0.046875 0.042969-0.09375 0.0625-0.14062 0.050782-0.10938 0.10547-0.21875 0.16016-0.32812 0.34766 0.23438 0.42969 0.54688 0.51562 0.9375 0.019531 0.10547 0.039062 0.20703 0.058594 0.3125 0.03125 0.003906 0.058593 0.007812 0.089843 0.011719 0.21484 0.074219 0.29297 0.32422 0.39062 0.51562 0.4375 0.90234 0.77734 1.9219 0.5 2.9258-0.19141 0.52734-0.46875 0.96484-0.97656 1.2266-0.86328 0.375-0.86328 0.375-1.25 0.26172-0.1875-0.19141-0.28516-0.42969-0.29688-0.69531 0.003906-0.24219 0.039062-0.47656 0.078125-0.71094 0.007812-0.050781 0.019531-0.097656 0.027344-0.14453 0.10937-0.59375 0.25391-1.2617 0.52734-1.8086-0.62109 0.57031-0.71094 1.8516-0.86328 2.6406-0.050781 0.003906-0.10156 0.003906-0.15234 0.007813-0.0625 0.003906-0.12891 0.007812-0.19531 0.011719-0.046875 0-0.046875 0-0.097656 0.003906-0.19141 0.011718-0.34375 0.039062-0.51563 0.12109 0.054688-0.003907 0.10938-0.003907 0.16797-0.007813 0.074219 0 0.14844-0.003906 0.22266-0.003906 0.035156 0 0.070312-0.003907 0.10937-0.003907 0.25781-0.003906 0.39844 0.035157 0.60156 0.20703 0.12891 0.19141 0.17969 0.34766 0.14453 0.57812-0.09375 0.089843-0.09375 0.089843-0.19141 0.14062-0.011719-0.097656-0.019531-0.19531-0.03125-0.29297-0.007812-0.089844-0.007812-0.089844-0.0625-0.13672-0.011719 0.089844-0.011719 0.089844-0.019531 0.1875-0.019531 0.18359-0.019531 0.18359-0.125 0.29297-0.14453 0.011719-0.28906 0.003906-0.43359 0-0.015625-0.17578-0.03125-0.34766-0.046875-0.52734h-0.097656c0.003906 0.046875 0.003906 0.046875 0.007812 0.10156 0 0.042968 0 0.085937 0.003906 0.13281 0 0.0625 0 0.0625 0.003907 0.12891-0.003907 0.039063-0.011719 0.078126-0.015625 0.11328-0.15234 0.10547-0.20312 0.12109-0.38281 0.097656-0.078125-0.058594-0.078125-0.058594-0.14453-0.14453-0.015625-0.11719-0.015625-0.11719-0.007812-0.25 0-0.0625 0-0.0625 0.003906-0.12891 0-0.035156 0.003906-0.066406 0.003906-0.10156h-0.097656c-0.023438 0.28516-0.023438 0.28516-0.046875 0.57812-0.19141-0.050781-0.19141-0.050781-0.23828-0.097656-0.007813-0.10547-0.007813-0.20703-0.007813-0.3125 0-0.03125-0.003906-0.066407-0.003906-0.10156v-0.21094c0-0.11719-0.003907-0.23047-0.003907-0.34375-0.003906-0.32422-0.003906-0.64453-0.007812-0.96875 0-0.19922-0.003906-0.39453-0.007812-0.59375v-0.22266c-0.003907-0.43359-0.023438-0.85156-0.11328-1.2773v0.097656c0 0.31641 0 0.62891 0.003906 0.94141v0.48438c0.003907 1.2305 0.003907 1.2305-0.027343 1.8281 0 0.039063 0 0.078125-0.003907 0.12109-0.015624 0.26562-0.015624 0.26562-0.070312 0.32031-0.11328 0.003906-0.22266 0.003906-0.33594 0.003906h-0.10547-0.21484-0.33203-0.20703-0.10156c-0.23047 0-0.23047 0-0.28516-0.054688-0.019531-0.12891-0.039063-0.25781-0.054688-0.38672-0.003906-0.039063-0.007812-0.078126-0.011719-0.12109-0.015624-0.12891-0.03125-0.26172-0.046874-0.39453-0.011719-0.089843-0.023438-0.17969-0.035157-0.26953-0.03125-0.26562-0.0625-0.52734-0.09375-0.79297-0.003906-0.058593-0.003906-0.058593-0.011719-0.11328-0.023437-0.21484-0.050781-0.43359-0.074218-0.64844-0.003906-0.054688-0.011719-0.10547-0.015625-0.16016-0.035157-0.31641-0.046875-0.63281-0.039063-0.95313h-0.097656c0.015625 0.89453 0.085938 1.7734 0.17578 2.6602 0.10938 1.125 0.10938 1.125 0.0625 1.4688-0.14062 0.097656-0.14062 0.097656-0.38281 0.097656-0.023438-0.23828-0.023438-0.23828-0.046875-0.48047-0.015625 0.078125-0.027344 0.15234-0.039063 0.23438-0.023437 0.12891-0.023437 0.12891-0.058593 0.24609-0.17969 0.11719-0.26953 0.11719-0.48047 0.09375-0.11328-0.070313-0.11328-0.070313-0.19141-0.19141-0.027343-0.12891-0.039062-0.25-0.046874-0.38281-0.03125 0.15625-0.0625 0.31641-0.097657 0.48047-0.16016 0.007813-0.16016 0.007813-0.33594 0-0.11719-0.17578-0.10156-0.27344-0.09375-0.48047-0.09375 0.09375-0.082032 0.25781-0.097656 0.38281-0.046876-0.03125-0.09375-0.0625-0.14453-0.09375-0.027344-0.18359-0.007812-0.27344 0.078125-0.44141 0.13672-0.16406 0.27344-0.3125 0.5-0.33984 0.10156 0.003906 0.20312 0.011719 0.30469 0.023437 0.054687 0.003906 0.054687 0.003906 0.10547 0.011719 0.089843 0.007813 0.17578 0.015625 0.26172 0.023437-0.23047-0.10547-0.41797-0.16406-0.67188-0.19141-0.25391-0.71484-0.50391-1.4297-0.70312-2.1641-0.042968-0.16016-0.09375-0.32031-0.14062-0.48047-0.015625-0.042969-0.027343-0.082031-0.039062-0.125-0.023438-0.078125-0.050781-0.15234-0.074219-0.22656-0.23047-0.74609-0.26953-1.4844-0.26953-2.2617 0-0.16406-0.003907-0.32422-0.007813-0.49219-0.003906-0.64844 0.066406-1.1875 0.32031-1.7852-0.046875-0.03125-0.09375-0.0625-0.14453-0.097656l0.19531-0.09375c0.035156 0.035156 0.070312 0.074218 0.10938 0.11328 0.125 0.12891 0.125 0.12891 0.27344 0.22266-0.023437-0.035156-0.046874-0.070312-0.070312-0.10547-0.28125-0.43359-0.42969-0.76562-0.45703-1.2891-0.074219 0.027344-0.074219 0.027344-0.14453 0.050781 0.007812-0.09375 0.011718-0.18359 0.019531-0.27344 0.003906-0.050782 0.007812-0.10156 0.011719-0.15234 0.015624-0.13281 0.035156-0.26172 0.0625-0.39062-0.046876-0.015625-0.09375-0.03125-0.14063-0.046875 0.14063-0.43359 0.14063-0.43359 0.17969-0.52344 0.12109-0.32422 0.13281-0.64062 0.14453-0.98828 0.027344-0.49219 0.085938-0.96484 0.19922-1.4453 0.011719-0.050781 0.023438-0.10547 0.035156-0.16016 0.058594-0.22656 0.10156-0.39844 0.25391-0.58203z"
                            fill="#ffffff" />
                        <!-- white rim -->
                        <path
                            d="m14.641 0.76953c0.058594 0.011719 0.12109 0.027344 0.18359 0.042969 2.4141 0.60547 4.6719 2.0078 6.1992 3.9883 0.039062 0.046875 0.074218 0.09375 0.11328 0.14062 1.8516 2.3008 2.6172 5.3242 2.3594 8.2383-0.054688 0.49219-0.15625 0.97656-0.26562 1.4609-0.011719 0.058594-0.023438 0.11719-0.039063 0.17969-0.375 1.5156-1.0547 2.9648-2.0234 4.1875-0.046875 0.058594-0.046875 0.058594-0.09375 0.12109-0.54688 0.69922-1.1719 1.3516-1.875 1.8945-0.042969 0.035156-0.042969 0.035156-0.085938 0.066406-0.44922 0.35156-0.90625 0.66406-1.4023 0.94141-0.03125 0.019531-0.058594 0.035156-0.09375 0.054688-1.7383 0.99219-3.7109 1.4453-5.7031 1.4414h-0.097656c-3.082-0.007813-5.9414-1.3359-8.1133-3.4922-0.27734-0.27734-0.53516-0.56641-0.77344-0.88281-0.023438-0.03125-0.046876-0.058594-0.070313-0.089844-1.8594-2.4414-2.7148-5.5586-2.3242-8.6094 0.29688-1.9688 1.0508-3.8984 2.2969-5.4609 0.035157-0.042969 0.070313-0.085938 0.10547-0.13281 0.56641-0.70703 1.1914-1.3789 1.9102-1.9297 0.042969-0.035157 0.042969-0.035157 0.089844-0.070313 1.4609-1.1289 3.1211-1.8164 4.9102-2.2109 0.09375-0.023438 0.09375-0.023438 0.18359-0.074219 1.5-0.24219 3.1367-0.16016 4.6094 0.19531zm-8.7852 2.6875c-0.027344 0.019531-0.058594 0.039063-0.085938 0.0625-0.39062 0.28125-0.74219 0.59375-1.0898 0.92578-0.066407 0.0625-0.13281 0.125-0.19922 0.1875-0.32812 0.31641-0.60547 0.66797-0.87891 1.0312-0.035156 0.042969-0.070312 0.089844-0.10547 0.13672-1.5938 2.125-2.2969 4.8945-1.9453 7.5234 0.085938 0.57031 0.19531 1.1484 0.37109 1.6992 0.007813 0.03125 0.019531 0.0625 0.027344 0.097656 0.62891 2.0039 1.8477 3.8516 3.5234 5.1367 0.027344 0.019532 0.054688 0.039063 0.082032 0.0625 2.2812 1.7422 5.1016 2.4883 7.9492 2.1133 1.8438-0.26953 3.6289-1.043 5.0703-2.2266 0.027343-0.019531 0.054687-0.042969 0.082031-0.066406 1.957-1.6094 3.2578-3.8203 3.7109-6.3164 0.011718-0.0625 0.011718-0.0625 0.023437-0.125 0.48438-2.5625-0.16016-5.3555-1.6055-7.5078-0.6875-0.98828-1.4844-1.875-2.4492-2.5898-0.027344-0.023437-0.054688-0.042968-0.082032-0.0625-1.2812-0.97656-2.8086-1.5977-4.3828-1.9062-0.054688-0.011718-0.10938-0.023437-0.16797-0.035156-2.7266-0.50391-5.6211 0.24219-7.8477 1.8594z"
                            fill="#ffffff" />
                        <!-- Tail and left leg -->
                        <path
                            d="m8.1133 14.594c0.10547 0.16016 0.13281 0.27734 0.17578 0.46484 0.125 0.52344 0.28906 1.0352 0.45313 1.5508 0.046874 0.14453 0.089843 0.28906 0.13672 0.43359 0.027344 0.089843 0.054688 0.17969 0.085938 0.26953 0.24219 0.76953 0.24219 0.76953 0.15625 0.97656-0.039063 0.027344-0.074219 0.050782-0.11328 0.078126-0.13672 0.12109-0.16797 0.19141-0.23047 0.35937-0.019532 0.042969-0.035156 0.085938-0.050782 0.13281-0.011718 0.03125-0.027343 0.066406-0.039062 0.10156-0.21484 0.003906-0.42969 0.007812-0.64062 0.007812-0.074219 0.003906-0.14844 0.003906-0.21875 0.003906-0.48828 0.011719-0.88672-0.027344-1.3477-0.20312v-0.097656c0.042969-0.011719 0.042969-0.011719 0.082031-0.023437 0.12891-0.035157 0.25391-0.070313 0.38281-0.10938 0.042969-0.011718 0.085938-0.023437 0.13281-0.035156 0.23828-0.070312 0.42188-0.13281 0.60156-0.3125 0.015624-0.03125 0.03125-0.0625 0.046874-0.09375 0.20703 0.085938 0.32813 0.22656 0.47656 0.38672 0.10938 0.097656 0.20312 0.14062 0.33984 0.1875-0.070313-0.0625-0.070313-0.0625-0.14062-0.12891-0.62109-0.625-0.92969-1.3438-0.92969-2.2227 0.011719-0.61719 0.25391-1.2422 0.64062-1.7266z"
                            fill="#ffffff" />
                        <!-- right ear -->
                        <path
                            d="m14.164 4.5938c0.11328 0.078125 0.125 0.11719 0.15234 0.25 0.007813 0.039062 0.015625 0.078125 0.023438 0.11719 0.011718 0.0625 0.011718 0.0625 0.023437 0.12891 0.007813 0.039062 0.015625 0.082031 0.027344 0.125 0.074219 0.42578 0.074219 0.83984 0.058594 1.2656-0.19141-0.089844-0.36328-0.20312-0.54297-0.32031-0.03125-0.019531-0.0625-0.039062-0.09375-0.058594-0.074219-0.050781-0.15234-0.10156-0.22656-0.14844 0.023437-0.23828 0.097656-0.40234 0.21094-0.60938 0.03125-0.054688 0.058594-0.10938 0.089844-0.16406 0.054687-0.097657 0.11719-0.19141 0.17578-0.28516-0.27734 0.28125-0.45703 0.60938-0.62109 0.96094-0.35938-0.14062-0.35938-0.14062-0.72266-0.28906 0.19922-0.39062 0.66016-0.625 1.0352-0.84766 0.027344-0.015625 0.054688-0.035156 0.082032-0.050781 0.19922-0.11719 0.19922-0.11719 0.32812-0.074219z"
                            fill="#ffffff" />
                        <!-- left inner ear -->
                        <path
                            d="m9.168 5.1836c0.30078 0.039062 0.43359 0.20703 0.625 0.43359 0.40625 0.54687 0.40625 0.54687 0.38281 0.86328-0.09375 0.16797-0.19531 0.27344-0.38281 0.33594 0.03125-0.0625 0.0625-0.12891 0.09375-0.19141-0.19531 0.023438-0.29297 0.074219-0.4375 0.21094-0.03125 0.027343-0.0625 0.054687-0.09375 0.085937-0.058594 0.054687-0.11328 0.10938-0.16797 0.16797-0.066406 0.0625-0.066406 0.0625-0.16406 0.0625-0.097657-0.24609-0.11328-0.46094-0.10938-0.72266v-0.12109c0.003907-0.38672 0.035157-0.79688 0.25391-1.125z"
                            fill="#ffffff" />
                        <path
                            d="m11.621 7.0938c0.16016 0.085938 0.29688 0.17969 0.37891 0.34766 0 0.11719 0 0.11719-0.046875 0.23828-0.22266 0.20312-0.36719 0.25781-0.66016 0.25391-0.16797-0.019532-0.24219-0.074219-0.34766-0.20703-0.039062-0.17969-0.039062-0.17969-0.050781-0.33594-0.10938 0.03125-0.21875 0.066406-0.33594 0.097656 0.019531-0.125 0.035156-0.17969 0.13281-0.26172 0.30078-0.17578 0.58984-0.25781 0.92969-0.13281z"
                            fill="#000000" />
                        <!-- <path
            d="m9.168 5.1836c0.30078 0.039062 0.43359 0.20703 0.625 0.43359 0.40625 0.54687 0.40625 0.54687 0.38281 0.86328-0.09375 0.16797-0.19531 0.27344-0.38281 0.33594 0.03125-0.0625 0.0625-0.12891 0.09375-0.19141-0.19531 0.023438-0.29297 0.074219-0.4375 0.21094-0.03125 0.027343-0.0625 0.054687-0.09375 0.085937-0.058594 0.054687-0.11328 0.10938-0.16797 0.16797-0.066406 0.0625-0.066406 0.0625-0.16406 0.0625-0.097657-0.24609-0.11328-0.46094-0.10938-0.72266v-0.12109c0.003907-0.38672 0.035157-0.79688 0.25391-1.125zm0.046875 0.097656c-0.15625 0.5625-0.16016 1.0977-0.14453 1.6797h0.097657c0.019531-0.035157 0.035156-0.070313 0.054687-0.10547 0.17578-0.26172 0.46094-0.39062 0.76172-0.47266-0.10156-0.39844-0.30078-0.70312-0.57812-1.0078-0.10156-0.0625-0.10156-0.0625-0.19141-0.09375z"
            fill="#181818" /> -->
                        <path
                            d="m14.16 6.9102c0.12109 0.070313 0.12109 0.070313 0.19141 0.14453v0.097656h-0.19141c0.003906 0.0625 0.003906 0.0625 0.011719 0.12891-0.015625 0.19922-0.054687 0.26953-0.20312 0.39844-0.16797 0.023437-0.27734 0.03125-0.42578-0.046876-0.085938-0.15234-0.11328-0.30859-0.10156-0.48047 0.19531-0.32031 0.37891-0.30859 0.71875-0.24219z"
                            fill="#000000" />
                        <path
                            d="m12.719 7.8242h0.57812c0.015625 0.0625 0.03125 0.125 0.046875 0.19141-0.023438 0.027344-0.046875 0.054687-0.070312 0.085937-0.11328 0.16406-0.089844 0.28906-0.074219 0.49219 0.11328 0.11328 0.18359 0.11719 0.33594 0.14062-0.015625 0.050781-0.03125 0.097656-0.046875 0.14453-0.21875 0.019532-0.21875 0.019532-0.32812-0.070312-0.019531-0.023438-0.035156-0.046875-0.054687-0.074219-0.10938 0.050781-0.19141 0.097656-0.28125 0.17578-0.15234 0.09375-0.26562 0.085938-0.44141 0.066406-0.03125-0.046874-0.0625-0.09375-0.09375-0.14453 0.085938-0.003906 0.085938-0.003906 0.17578-0.007812 0.16016-0.023438 0.21094-0.042969 0.35156-0.14062 0.10547-0.13672 0.10547-0.13672 0.12891-0.3125-0.019531-0.17578-0.019531-0.17578-0.17578-0.28125-0.050781-0.023438-0.097656-0.046875-0.14453-0.074219 0.03125-0.0625 0.0625-0.125 0.09375-0.19141z"
                            fill="#000000" />
                        <!-- <path
            d="m9.0234 5.8555h0.046874v1.1523h-0.09375c-0.066406-0.20312-0.058593-0.39062-0.058593-0.60156v-0.12891-0.12109-0.11328c0.011719-0.089844 0.011719-0.089844 0.10547-0.1875z"
            fill="#000000" /> -->
                        <path
                            d="m11.328 8.3984v0.050781c-0.21094 0.03125-0.41797 0.0625-0.62891 0.09375-0.058594 0.011719-0.11719 0.019531-0.17578 0.027343-0.085938 0.015626-0.085938 0.015626-0.17578 0.027344-0.078125 0.011719-0.078125 0.011719-0.16016 0.023438-0.16406 0.019531-0.32422 0.023437-0.49219 0.019531 0.17188-0.10156 0.35156-0.13672 0.54688-0.17578 0.035156-0.003906 0.066406-0.011719 0.10156-0.019532 0.32812-0.054687 0.64844-0.058593 0.98438-0.046874z"
                            fill="#000000" />
                        <path
                            d="m11.375 8.5938c-0.16797 0.16797-0.41797 0.1875-0.64844 0.24609-0.074218 0.023437-0.074218 0.023437-0.15625 0.042968-0.046874 0.011719-0.097656 0.023438-0.14844 0.039063-0.066406 0.015625-0.066406 0.015625-0.13672 0.035156-0.10938 0.019531-0.10938 0.019531-0.20703-0.027343 0.87109-0.36719 0.87109-0.36719 1.2969-0.33594z"
                            fill="#000000" />
                    </g>
                </svg>
            </div>
            <h2>Welcome to Bronx</h2>
            <p>Select a model and start chatting with your local AI assistant.<br>
                Ask questions, get code suggestions, and explore ideas together.</p>
        </div>
    </div>

    <div class="input-container">
        <div class="input-top-row">
            <div class="model-selector-container">
                <select class="model-selector" id="modelSelector">
                    <option value="">Select Model...</option>
                </select>
            </div>
        </div>
        
        <div class="input-main-container">
            <textarea class="input-box" id="messageInput" 
                placeholder="Add context (#), extensions (@), commands (/)"
                rows="1"></textarea>
            <div class="input-actions">
                <button class="action-button" id="micButton" title="Voice input">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2a3 3 0 0 0-3 3v6a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
                        <path d="M19 10v1a7 7 0 0 1-14 0v-1"/>
                        <path d="M12 18v4"/>
                        <path d="M8 22h8"/>
                    </svg>
                </button>
                <button class="send-button" id="sendButton" disabled title="Send message">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M22 2 11 13"/>
                        <path d="M22 2 15 22 11 13 2 9 22 2Z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script nonce="{{nonce}}">
        const vscode = acquireVsCodeApi();

        // DOM elements
        const modelSelector = document.getElementById('modelSelector');
        const modelStatus = document.getElementById('modelStatus');
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const micButton = document.getElementById('micButton');

        let currentState = vscode.getState() || {
            messages: [],
            selectedModel: '',
            isLoading: false
        };

        // Initialize
        function init() {
            updateModelSelector();
            restoreState();
            setupEventListeners();
            requestModelList();
        }

        function setupEventListeners() {
            modelSelector.addEventListener('change', handleModelChange);
            sendButton.addEventListener('click', sendMessage);
            micButton.addEventListener('click', handleMicClick);
            messageInput.addEventListener('keydown', handleKeyDown);
            messageInput.addEventListener('input', handleInputChange);

            // Handle messages from extension
            window.addEventListener('message', handleExtensionMessage);
        }

        function handleExtensionMessage(event) {
            const message = event.data;

            switch (message.type) {
                case 'modelList':
                    updateModelSelector(message.models);
                    break;
                case 'modelLoaded':
                    updateModelStatus(message.model, 'loaded');
                    break;
                case 'response':
                    addMessage('assistant', message.text);
                    setLoading(false);
                    break;
                case 'error':
                    addMessage('assistant', `Error: ${message.text}`);
                    setLoading(false);
                    break;
                case 'downloadProgress':
                    updateDownloadProgress(message.progress);
                    break;
            }
        }

        function requestModelList() {
            vscode.postMessage({ type: 'getModelList' });
        }

        function updateModelSelector(models = []) {
            modelSelector.innerHTML = '<option value="">Select Model...</option>';

            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.modelname;
                option.textContent = `${model.modelname} (${model.size || 'Unknown size'})${model.downloaded ? '' : ' - Not downloaded'}`;
                option.disabled = !model.downloaded;
                modelSelector.appendChild(option);
            });

            if (currentState.selectedModel) {
                modelSelector.value = currentState.selectedModel;
            }
        }

        function handleModelChange() {
            const selectedModel = modelSelector.value;
            if (selectedModel && selectedModel !== currentState.selectedModel) {
                currentState.selectedModel = selectedModel;
                saveState();
                vscode.postMessage({ type: 'selectModel', model: selectedModel });
                updateModelStatus(selectedModel, 'loading');
            }
        }

        function updateModelStatus(model, status) {
            switch (status) {
                case 'loading':
                    modelStatus.textContent = `Loading ${model}...`;
                    sendButton.disabled = true;
                    break;
                case 'loaded':
                    modelStatus.textContent = `${model} ready`;
                    sendButton.disabled = false;
                    break;
                case 'error':
                    modelStatus.textContent = `Error loading ${model}`;
                    sendButton.disabled = true;
                    break;
                default:
                    modelStatus.textContent = 'No model selected';
                    sendButton.disabled = true;
            }
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function handleInputChange() {
            // Auto-resize textarea
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
            
            // Enable/disable send button
            const hasText = messageInput.value.trim().length > 0;
            const hasModel = currentState.selectedModel && !currentState.isLoading;
            sendButton.disabled = !hasText || !hasModel;
        }

        function handleMicClick() {
            // Placeholder for voice input functionality
            // You can implement speech recognition here
            console.log('Voice input clicked - feature to be implemented');
            
            // For now, just show a tooltip or notification
            micButton.title = 'Voice input (coming soon)';
            setTimeout(() => {
                micButton.title = 'Voice input';
            }, 2000);
        }

        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !currentState.selectedModel || currentState.isLoading) {
                return;
            }

            addMessage('user', text);
            setLoading(true);

            vscode.postMessage({
                type: 'sendMessage',
                text: text,
                model: currentState.selectedModel
            });

            messageInput.value = '';
            messageInput.style.height = 'auto';
        }

        function addMessage(role, content) {
            const message = {
                id: Date.now().toString(),
                role: role,
                content: content,
                timestamp: new Date()
            };

            currentState.messages.push(message);
            saveState();
            renderMessage(message);
            scrollToBottom();

            // Remove empty state if it's the first message
            const emptyState = chatContainer.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }
        }

        function renderMessage(message) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${message.role}`;

            // Process content for code blocks
            const processedContent = processCodeBlocks(message.content);
            messageEl.innerHTML = processedContent;

            // Add timestamp
            const timestamp = document.createElement('div');
            timestamp.className = 'timestamp';
            timestamp.textContent = new Date(message.timestamp).toLocaleTimeString();
            messageEl.appendChild(timestamp);

            chatContainer.appendChild(messageEl);
        }

        function processCodeBlocks(content) {
            // Simple code block processing
            return content.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, language, code) => {
                const lang = language || 'text';
                return `
                    <div class="code-block">
                        <div class="code-header">
                            <span>${lang}</span>
                            <div class="code-actions">
                                <button class="code-action-btn" onclick="copyCode(this)">Copy</button>
                                <button class="code-action-btn" onclick="insertCode(this)">Insert</button>
                            </div>
                        </div>
                        <div class="code-content">${escapeHtml(code.trim())}</div>
                    </div>
                `;
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function copyCode(button) {
            const codeContent = button.closest('.code-block').querySelector('.code-content').textContent;
            navigator.clipboard.writeText(codeContent).then(() => {
                button.textContent = 'Copied!';
                setTimeout(() => {
                    button.textContent = 'Copy';
                }, 2000);
            });
        }

        function insertCode(button) {
            const codeContent = button.closest('.code-block').querySelector('.code-content').textContent;
            vscode.postMessage({
                type: 'insertCode',
                code: codeContent
            });
        }

        function setLoading(isLoading) {
            currentState.isLoading = isLoading;
            saveState();

            if (isLoading) {
                const loadingEl = document.createElement('div');
                loadingEl.className = 'loading';
                loadingEl.innerHTML = '<div class="loading-spinner"></div>Thinking...';
                loadingEl.id = 'loading-indicator';
                chatContainer.appendChild(loadingEl);
                scrollToBottom();
            } else {
                const loadingEl = document.getElementById('loading-indicator');
                if (loadingEl) {
                    loadingEl.remove();
                }
            }

            sendButton.disabled = isLoading || !currentState.selectedModel || !messageInput.value.trim();
        }

        function updateDownloadProgress(progress) {
            let progressEl = document.getElementById('download-progress');

            if (!progressEl) {
                progressEl = document.createElement('div');
                progressEl.id = 'download-progress';
                progressEl.className = 'download-progress';
                chatContainer.appendChild(progressEl);
            }

            progressEl.innerHTML = `
                <div>Downloading ${progress.modelName}: ${progress.progress}%</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress.progress}%"></div>
                </div>
            `;

            if (progress.status === 'completed') {
                setTimeout(() => {
                    progressEl.remove();
                    requestModelList(); // Refresh model list
                }, 2000);
            }

            scrollToBottom();
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function saveState() {
            vscode.setState(currentState);
        }

        function restoreState() {
            if (currentState.messages.length > 0) {
                // Remove empty state
                const emptyState = chatContainer.querySelector('.empty-state');
                if (emptyState) {
                    emptyState.remove();
                }

                // Render messages
                currentState.messages.forEach(renderMessage);
                scrollToBottom();
            }

            if (currentState.selectedModel) {
                modelSelector.value = currentState.selectedModel;
                updateModelStatus(currentState.selectedModel, 'loaded');
            }

            if (currentState.isLoading) {
                setLoading(true);
            }
        }

        // Initialize the app
        init();
    </script>
</body>

</html>